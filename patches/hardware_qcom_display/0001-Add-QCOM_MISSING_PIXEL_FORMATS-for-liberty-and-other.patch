From b556b72f86860235170339bca921b41c02d82a86 Mon Sep 17 00:00:00 2001
From: WinSuk <goodboy735@gmail.com>
Date: Thu, 4 Oct 2012 20:33:41 -0700
Subject: [PATCH] Add QCOM_MISSING_PIXEL_FORMATS for liberty (and other
 devices with outdated kernels)

---
 liboverlay/overlayMdp.cpp     |    2 ++
 liboverlay/overlayRotator.cpp |    2 ++
 liboverlay/overlayUtils.cpp   |    6 ++++++
 liboverlay/overlayUtils.h     |   10 ++++++++++
 4 files changed, 20 insertions(+), 0 deletions(-)

diff --git a/liboverlay/overlayMdp.cpp b/liboverlay/overlayMdp.cpp
index 35235e1..fef8de8 100644
--- a/liboverlay/overlayMdp.cpp
+++ b/liboverlay/overlayMdp.cpp
@@ -197,11 +197,13 @@ bool MdpCtrl::get() {
 void MdpCtrl::adjustSrcWhf(const bool& rotUsed) {
     if(rotUsed) {
         utils::Whf whf = getSrcWhf();
+#ifndef QCOM_MISSING_PIXEL_FORMATS
         if(whf.format == MDP_Y_CRCB_H2V2_TILE ||
                 whf.format == MDP_Y_CBCR_H2V2_TILE) {
             whf.w = utils::alignup(whf.w, 64);
             whf.h = utils::alignup(whf.h, 32);
         }
+#endif
         //For example: If original format is tiled, rotator outputs non-tiled,
         //so update mdp's src fmt to that.
         whf.format = utils::getRotOutFmt(whf.format);
diff --git a/liboverlay/overlayRotator.cpp b/liboverlay/overlayRotator.cpp
index b4eede9..6349395 100644
--- a/liboverlay/overlayRotator.cpp
+++ b/liboverlay/overlayRotator.cpp
@@ -54,11 +54,13 @@ void MdpRot::setSource(const overlay::utils::Whf& awhf) {
     utils::Whf whf(awhf);
 
     mRotImgInfo.src.format = whf.format;
+#ifndef QCOM_MISSING_PIXEL_FORMATS
     if(whf.format == MDP_Y_CRCB_H2V2_TILE ||
         whf.format == MDP_Y_CBCR_H2V2_TILE) {
         whf.w =  utils::alignup(awhf.w, 64);
         whf.h = utils::alignup(awhf.h, 32);
     }
+#endif
 
     mRotImgInfo.src.width = whf.w;
     mRotImgInfo.src.height = whf.h;
diff --git a/liboverlay/overlayUtils.cpp b/liboverlay/overlayUtils.cpp
index 44ebd3c..f19023f 100644
--- a/liboverlay/overlayUtils.cpp
+++ b/liboverlay/overlayUtils.cpp
@@ -163,24 +163,30 @@ int getMdpFormat(int format) {
             return MDP_RGB_565;
         case HAL_PIXEL_FORMAT_BGRA_8888:
             return MDP_BGRA_8888;
+#ifndef QCOM_MISSING_PIXEL_FORMATS
         case HAL_PIXEL_FORMAT_YV12:
             return MDP_Y_CR_CB_GH2V2;
+#endif
         case HAL_PIXEL_FORMAT_YCbCr_422_SP:
             return MDP_Y_CBCR_H2V1;
         case HAL_PIXEL_FORMAT_YCrCb_420_SP:
             return MDP_Y_CRCB_H2V2;
 
         //From gralloc_priv.h
+#ifndef QCOM_MISSING_PIXEL_FORMATS
         case HAL_PIXEL_FORMAT_YCbCr_420_SP_TILED:
             return MDP_Y_CBCR_H2V2_TILE;
+#endif
         case HAL_PIXEL_FORMAT_YCbCr_420_SP:
             return MDP_Y_CBCR_H2V2;
         case HAL_PIXEL_FORMAT_YCrCb_422_SP:
             return MDP_Y_CRCB_H2V1;
+#ifndef QCOM_MISSING_PIXEL_FORMATS
         case HAL_PIXEL_FORMAT_YCbCr_444_SP:
             return MDP_Y_CBCR_H1V1;
         case HAL_PIXEL_FORMAT_YCrCb_444_SP:
             return MDP_Y_CRCB_H1V1;
+#endif
 
         default:
             //Unsupported by MDP
diff --git a/liboverlay/overlayUtils.h b/liboverlay/overlayUtils.h
index 4509a27..434b678 100644
--- a/liboverlay/overlayUtils.h
+++ b/liboverlay/overlayUtils.h
@@ -545,12 +545,18 @@ inline bool isYuv(uint32_t format) {
         case MDP_Y_CBCR_H2V1:
         case MDP_Y_CBCR_H2V2:
         case MDP_Y_CRCB_H2V2:
+#ifndef QCOM_MISSING_PIXEL_FORMATS
         case MDP_Y_CRCB_H1V1:
+#endif
         case MDP_Y_CRCB_H2V1:
+#ifndef QCOM_MISSING_PIXEL_FORMATS
         case MDP_Y_CRCB_H2V2_TILE:
         case MDP_Y_CBCR_H2V2_TILE:
+#endif
         case MDP_Y_CR_CB_H2V2:
+#ifndef QCOM_MISSING_PIXEL_FORMATS
         case MDP_Y_CR_CB_GH2V2:
+#endif
             return true;
         default:
             return false;
@@ -692,14 +698,18 @@ inline int getMdpOrient(eTransform rotation) {
 
 inline int getRotOutFmt(uint32_t format) {
     switch (format) {
+#ifndef QCOM_MISSING_PIXEL_FORMATS
         case MDP_Y_CRCB_H2V2_TILE:
             return MDP_Y_CRCB_H2V2;
         case MDP_Y_CBCR_H2V2_TILE:
             return MDP_Y_CBCR_H2V2;
+#endif
         case MDP_Y_CB_CR_H2V2:
             return MDP_Y_CBCR_H2V2;
+#ifndef QCOM_MISSING_PIXEL_FORMATS
         case MDP_Y_CR_CB_GH2V2:
             return MDP_Y_CRCB_H2V2;
+#endif
         default:
             return format;
     }
-- 
1.7.7.5 (Apple Git-26)

